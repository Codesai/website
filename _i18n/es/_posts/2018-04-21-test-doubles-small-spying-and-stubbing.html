---
layout: post
title: "A small spying and stubbing library for Clojure and ClojureScript: test-doubles"
date: 2018-04-21 22:30:00.000000000 +01:00
type: post
published: true
status: publish
categories:
  - Clojure/ClojureScript
  - Open Source
  - Testing
  - Test Doubles  

author: Manuel Rivero
twitter: trikitrok
small_image: small_pineapples.jpeg
written_in: english
cross_post_url: http://garajeando.blogspot.com.es/2018/04/test-doubles-small-spying-and-stubbing.html
---

<div style="text-align: justify;">
As you may know from a <a href="https://www.codesai.com/2017/06/testing-om-components">previous post</a> I&#8217;m working for <a href="http://www.greenpowermonitor.com/">GreenPowerMonitor</a>
as part of a team that is developing a challenging SPA to monitor and manage renewable energy portfolios using ClojureScript.
</div>
<br>
<div style="text-align: justify;">
We were dealing with some legacy code that was effectful and needed to be tested using <a href="http://xunitpatterns.com/Test%20Double.html">test doubles</a>, 
so we explored some existing ClojureScript libraries but we didn't feel comfortable with them. On one hand, we found that some of them had different macros for different types of test doubles and this made tests that needed both spies and stubs become very nested. We wanted to produce tests with as little nesting as possible. On the other hand, being used to <a href="https://martinfowler.com/bliki/TestDouble.html">Gerard Meszaros&#8217; vocabulary for tests doubles</a>, we found the naming used for different types of tests doubles in some of the existing libraries a bit confusing. We wanted to stick to <a href="https://martinfowler.com/bliki/TestDouble.html">Gerard Meszaros&#8217; vocabulary for tests doubles</a>. 
</div>
<br>
<div style="text-align: justify;">
So we decided we'd write our own <a href="http://xunitpatterns.com/Test%20Stub.html">stubs</a> and <a href="http://xunitpatterns.com/Test%20Spy.html">spies</a> library. 
</div>
<br>
<div style="text-align: justify;">
We started by manually creating our own spies and stubs during some time so that we could identify the different ways in which we were going to use them. After a while, my colleague <a href="https://github.com/andrestylianos">Andr√© Stylianos Ramos</a> and I wrote our own small DSL to create stubs and spies using macros to remove all that duplication and boiler plate. The result was a small library that we've been using in our ClojureScript project for nearly a year and that we've recently adapted to make it work in Clojure as well: 
</div>
<br>
<script src="https://gist.github.com/trikitrok/5ed98db6faa4f7a6390ab422a3aed280.js"></script>

<div style="text-align: justify;">
I&#8217;m really glad to announce that <a href="http://www.greenpowermonitor.com/">GreenPowerMonitor</a> has open-sourced our small spying and stubbing library for Clojure and ClojureScript: <a href="https://github.com/GreenPowerMonitor/test-doubles">test-doubles</a>.
</div>
<br>
<div style="text-align: justify;">
In the following example written in ClojureScript, we show how we are using <code>test-doubles</code> to create two <a href="https://github.com/GreenPowerMonitor/test-doubles/blob/master/README.md#1-stubbing-function-calls">stubs</a> (one with the <a href="https://github.com/GreenPowerMonitor/test-doubles/blob/master/README.md#13-maps">:maps option</a> and another with the <a href="https://github.com/GreenPowerMonitor/test-doubles/blob/master/README.md#11-returns-option">:returns option</a>) and a <a href="https://github.com/GreenPowerMonitor/test-doubles/blob/master/README.md#2-spying-function-calls">spy</a>:
</div>
<br>
<script src="https://gist.github.com/trikitrok/4a6a2f9f1ac41932bb467cb1f80fed4e.js"></script>

<div style="text-align: justify;">
We could show you more examples here of how <code>test-doubles</code> can be used and the different options it provides, but we&#8217;ve already included a lot of explained examples in its <a href="https://github.com/GreenPowerMonitor/test-doubles/blob/master/README.md">documentation</a>.
</div>
<br>
<div style="text-align: justify;">
Please do have a look and try our library. You can get its <a href="https://clojars.org/greenpowermonitor/test-doubles">last version from Clojars</a>. We hope it might be as useful to you as it has been for us.
</div>